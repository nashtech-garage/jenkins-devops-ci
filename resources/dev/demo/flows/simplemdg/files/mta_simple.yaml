ID: simple-mdg
_schema-version: "3.2"
description: SimpleMDG Solution
parameters:
  deploy_mode: html5-repo
  enable-parallel-deployments: true
version: 1.0.0
modules:
  - name: simple-mdg-web
    type: approuter.nodejs
    path: approuter
    parameters:
      memory: 128M
      disk-quota: 200M
    build-parameters:
      ignore: ["package-lock.json", "default*.json", "node_modules/"]
    provides:
      - name: approuter
        properties:
          url: "${default-url}"
    requires:
      - name: application-logging
      - name: simple-mdg-html5-repo-runtime
      - name: simple-mdg-uaa
      - name: dest-service
      - name: connectivity-service
      - name: srv_api
        group: destinations
        properties:
          forwardAuthToken: true
          strictSSL: false
          name: srv_api
          url: "~{url}"
          timeout: 120000
    properties:
      SESSION_TIMEOUT: 30

  - name: simple-mdg-uideployer
    type: com.sap.html5.application-content
    path: uideployer
    requires:
      - name: simple-mdg-html5-repo-host
    build-parameters:
      requires:
        - name: simple-mdg-admin
          artifacts:
            - "./*"
          target-path: resources/admin
        - name: simple-mdg-main
          artifacts:
            - "./*"
          target-path: resources/main
        - name: simple-mdg-shared-ui5lib
          artifacts:
            - "./*"
          target-path: resources/shared-ui5lib

  - name: simple-mdg-admin
    type: html5
    path: admin
    build-parameters:
      ignore:
        [
          "package-lock.json",
          "node_modules/",
          "webapp/shared-ui5lib/",
          "webapp/appimage/",
        ]
      builder: custom
      commands:
        - npm install
        - npm run build
      supported-platforms: []
      build-result: dist

  - name: simple-mdg-main
    type: html5
    path: main
    build-parameters:
      ignore:
        [
          "package-lock.json",
          "node_modules/",
          "webapp/shared-ui5lib/",
          "webapp/appimage/",
        ]
      builder: custom
      commands:
        - npm install
        - npm run build
      supported-platforms: []
      build-result: dist

  - name: simple-mdg-shared-ui5lib
    type: html5
    path: shared-ui5lib
    build-parameters:
      ignore: ["package-lock.json", "node_modules/"]
      builder: custom
      commands:
        - npm install
        - npm run build
      supported-platforms: []
      build-result: dist

  - name: simple-mdg-db
    type: hdb
    path: db
    build-parameters:
      ignore: ["package-lock.json", "node_modules/", "undeploy.json"]
    parameters:
      memory: 1024M
      disk-quota: 4G
    properties:
      zdm-mode: true
    requires:
      - name: application-logging
      - name: simple-mdg-db-hdi-container

  - name: simple-mdg-srv
    type: nodejs
    deployed-after:
      - simple-mdg-db
    build-parameters:
      no-source: true
    parameters:
      memory: 2048M
      disk-quota: 4096M
      instances: 2
      allow_app_ssh_access: false
      health-check-http-endpoint: /health-check
      health-check-timeout: 360
      docker:
        image: ${baseImage}:srv-${laidonVersion}
        username: $GIT_USERNAME
        password: $GIT_PASSWORD
    provides:
      - name: srv_api
        properties:
          url: "${default-url}"
    requires:
      - name: application-logging
      - name: simple-mdg-db-hdi-container
      - name: simple-mdg-uaa
      - name: dest-service
      - name: connectivity-service
      - name: srv_api_bg
        group: destinations
        properties:
          name: srv_api_bg
          url: "~{url}"
      - name: approuter
        group: destinations
        properties:
          name: approuter
          url: "~{url}"
    properties:
      OPTIMIZE_MEMORY: true

  - name: simple-mdg-srv-bg
    type: nodejs
    build-parameters:
      no-source: true
    parameters:
      memory: 1024M
      disk-quota: 4096M
      allow_app_ssh_access: false
      health-check-http-endpoint: /health-check
      health-check-timeout: 360
      docker:
        image: ${baseImage}:srv-bg-${laidonVersion}
        username: $GIT_USERNAME
        password: $GIT_PASSWORD
    provides:
      - name: srv_api_bg
        properties:
          url: "${default-url}"
    requires:
      - name: application-logging
      - name: simple-mdg-db-hdi-container
      - name: simple-mdg-uaa
      - name: dest-service
      - name: connectivity-service
      - name: approuter
        group: destinations
        properties:
          name: approuter
          url: "~{url}"
    properties:
      OPTIMIZE_MEMORY: true

resources:
  - name: simple-mdg-html5-repo-runtime
    parameters:
      service-plan: app-runtime
      service: html5-apps-repo
    type: org.cloudfoundry.managed-service
  - name: simple-mdg-html5-repo-host
    parameters:
      service-plan: app-host
      service: html5-apps-repo
      config:
        sizeLimit: 20
    type: org.cloudfoundry.managed-service
  - name: dest-service
    type: destination
  - name: connectivity-service
    type: connectivity
  - name: simple-mdg-uaa
    type: org.cloudfoundry.managed-service
    parameters:
      path: ./xs-security.json
      service-plan: application
      service: xsuaa
  - name: simple-mdg-db-hdi-container
    type: com.sap.xs.hdi-container
    properties:
      hdi-container-name: "${service-name}"
  - name: application-logging
    type: org.cloudfoundry.managed-service
    parameters:
      service: application-logs
      service-plan: lite
